name: web-tests-matrix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  web-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: [3.10, 3.11]
        browser: [chrome, firefox]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python }}

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          wget gnupg ca-certificates xvfb \
          fonts-liberation libnss3 libgconf-2-4 libxss1 libasound2 \
          libatk1.0-0 libatk-bridge2.0-0 libcups2 libgbm1 libgtk-3-0 \
          libx11-xcb1 libxcb1

    - name: Install Google Chrome (stable)
      if: matrix.browser == 'chrome'
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        echo "CHROME_BINARY=/usr/bin/google-chrome-stable" >> $GITHUB_ENV

    - name: Install Chromium (fallback)
      if: matrix.browser == 'chrome' && failure()
      run: |
        sudo apt-get install -y chromium-browser
        echo "CHROME_BINARY=/usr/bin/chromium-browser" >> $GITHUB_ENV

    - name: Set browser env
      run: |
        echo "BROWSER=${{ matrix.browser }}" >> $GITHUB_ENV
        echo "HEADLESS=true" >> $GITHUB_ENV

    - name: Install Python deps
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests (headless)
      # use xvfb-run to ensure display is present for any webdriver headless behavior
      run: |
        xvfb-run -a pytest -q --maxfail=1 --tb=short tests/ --alluredir=allure-results
      env:
        # this ensures your test code can override or pick up PATH if needed
        CHROME_BINARY: ${{ env.CHROME_BINARY }}
        BROWSER: ${{ env.BROWSER }}
        HEADLESS: ${{ env.HEADLESS }}

    - name: Archive Allure results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results-${{ matrix.browser }}-py${{ matrix.python }}
        path: allure-results

    - name: Upload debug logs (chromedriver / chrome)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: chrome-debug-${{ matrix.browser }}
        path: |
          /tmp/chromedriver.log
          /tmp/chrome-*.log
