name: Web Tests Matrix (Firefox headless + Xvfb)

on:
  push:
  pull_request:

jobs:
  web-tests-firefox:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      BROWSER: firefox
      HEADLESS: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system deps (Xvfb)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xvfb libgtk-3-0 libdbus-glib-1-2

      - name: Install Python deps (pytest, selenium, webdriver-manager, allure)
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-xdist allure-pytest selenium webdriver-manager

      - name: Show installed firefox version
        run: |
          firefox --version || echo "firefox not in path"

      - name: Show Python and pip info
        run: |
          python --version
          pip --version
          pip show selenium webdriver-manager || true

      - name: Create Allure results folder & ensure logs dir
        run: |
          mkdir -p reports/allure-results/firefox
          mkdir -p ci-driver-logs

      - name: Run pytest (firefox) under Xvfb and save geckodriver.log
        env:
          BROWSER: firefox
          HEADLESS: "true"
        run: |
          # Use xvfb-run so Firefox has a display. Capture geckodriver logs in ci-driver-logs.
          # We call pytest as a module so it's the same interpreter: python -m pytest
          # Increase verbosity on failure for easier debugging.
          set -o pipefail
          xvfb-run -s "-screen 0 1920x1080x24" \
            python -m pytest -q --maxfail=1 --alluredir=reports/allure-results/firefox -k "not mobile" \
            2>&1 | tee pytest-run.log
        # If tests fail, still continue to upload artifacts (below) by using `if: always()` on upload steps.

      - name: Save pytest logs & list results
        if: always()
        run: |
          echo "==== pytest log head ===="
          head -n 200 pytest-run.log || true
          echo "==== Allure results listing ===="
          ls -la reports/allure-results/firefox || true

      - name: Upload Allure results artifact (firefox)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-firefox
          path: reports/allure-results/firefox

      - name: Upload pytest run log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-run-log
          path: pytest-run.log

      - name: Upload driver logs (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-driver-logs
          path: ci-driver-logs
